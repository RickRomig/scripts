#!/usr/bin/env bash
#############################################################################
# Script Name  : install-brave
# Description  : installs the Brave broswer
# Dependencies : apt-transport-https, curl, libu2f-udev
# Arguments    : --help, --install, --remove
# Author       : Richard B. Romig, 12 Dec 2019
# Email        : rick.romig@gmail.com
# Comments     : For Debian, Ubuntu, Mint ... (Code from Brave's instructions)
#              : Brave is only supported on 64-bit AMD/Intel architectures (amd64/x86_64).
# 23 Feb 2022  : Added 'getopts' to handle command-line options.
# 21 Mar 2022  : Changed usage function to Here-doc format.
# 25 Mar 2022  : Changed OpenGPG repo signing key method (apt-key deprecated).
# 26 Mar 2022  : Reverted to previous signing method.
# 29 Mar 2022  : Added $OPTARG to Invalid option message.
# 04 May 2022  : Added error code upon exit via usage function.
# 10 Jul 2022  : Added optstr and opt variables to getopts routine.
# 11 Oct 2022  : Cleaned up the script.
# TODO (Rick)  :
# License      : GNU General Public License, version 2.0
#############################################################################

## Shellcheck Directives ##
# shellcheck source=/home/rick/bin/functionlib
# shellcheck disable=SC1091

## Load function library ##

if [[ -x "$HOME/bin/functionlib" ]]; then
  source "$HOME/bin/functionlib"
else
  printf "\e[91mERROR:\e[0m functionlib not found!\n" >&2
  exit 1
fi

## Variables ##

readonly _script=$(basename "$0")
readonly _version="0.3.0"
readonly _updated="11 Oct 2022"
readonly red_error="${lightred}ERROR:${normal}"
readonly keyring_dir="/etc/apt/trusted.gpg.d"
readonly trusted_key="brave-browser-release.gpg"
readonly sources_list="/etc/apt/sources.list.d/brave-browser-release.list"

## Functions ##

install_brave() {
  local trusted_key_url="https://brave-browser-apt-release.s3.brave.com/brave-core.asc"
  local sources_list_url="https://brave-browser-apt-release.s3.brave.com/ stable main"
  # Install curl, apt-transport-https, libu2f-udev, if not installed
  check_dependencies
  printf "Installing the Brave Browser ...\n"
  # Import the public key for verification of the APT repository
  curl -s "$trusted_key_url" | sudo apt-key --keyring "$keyring_dir/$trusted_key" add - 2>/dev/null #apt-key deprecated
  # Add the repository
  echo "deb [arch=amd64] $sources_list_url" | sudo tee "$sources_list" < /dev/null
  # Install Brave
  sudo apt update -qq
  sudo apt install brave-browser -yy
  printf "Brave browser successfully installed.\n"
}

remove_brave() {
  sudo apt-get purge brave-browser
  [[ -f "$keyring_dir/$trusted_key" ]] && sudo rm "$keyring_dir/$trusted_key"
  sudo apt-key del C3D4E821 2>/dev/null #apt-key deprecated
  [[ -f "$sources_list" ]] && sudo rm "$sources_list"
  [[ -d "$HOME/.config/BraveSoftware" ]] && rm -rf "$HOME/.config/BraveSoftware"
  [[ -d "$HOME/.cache/BraveSoftware" ]] && rm -rf "$HOME/.cache/BraveSoftware"
  printf "Brave browser and configuration files have been removed.\n"
}

usage() {
  local errcode="${1:-2}"
  cat << END_HELP
${orange}Usage:${normal} $_script [-h] [-i] [-r]
Options:
  -h   help
  -i   Install the Brave Browser
  -r   Remove the Brave Browser
END_HELP
  printf "\U1F427 %s v%s (%s)\n" "$_script" "$_version" "$_updated"
  exit "$errcode"
}

check_dependencies() {
  check_package curl
  check_package apt-transport-https
  check_package libu2f-udev
}

## Execution ##

printf "Installs/Removes the Brave browser.\n\n"

if [[ $# -eq 0 ]]; then
  printf "%s No argument passed.\n" "$red_error" >&2
  usage 2
else
  optstr=":hir"
  while getopts "$optstr" opt; do
    case "$opt" in
      h )
        usage 0 ;;
      i )
        exists brave-browser && leave "Brave browser is already installed."
        user_in_sudo
        install_brave ;;
      r )
        exists brave-browser || leave "Brave browser is not installed."
        user_in_sudo
        remove_brave ;;
      ? )
        printf "%s Invalid option -%s\n" "$red_error" "$OPTARG" >&2
        usage 2 ;;
    esac
  done
fi
printf "\U1F427 %s v%s (%s)\n" "$_script" "$_version" "$_updated"
exit
