#!/bin/bash
###############################################################################
# Script Name  : bu
# Description  : USB backup tool
# Dependencies : rsync
# Arguments    : --help, --restore
# Author       : Copyright (C) 2023, Richard B. Romig, Created: 04 Feb 2023
# Email        : rick.romig@gmail.com | rick.romig@mymetronet.com
# Comments     : Based on USB Backup Tool (Version 1.1) by Joe Collins. (www.ezeelinux.com)
# Last updated : 31 Mar 2023
# TODO (Rick)  : 
# License      : GNU General Public License, version 2.0
###############################################################################

# BU -- USB Backup Tool (Version 1.1) -- by Joe Collins. (www.ezeelinux.com)
# A simple tool to create reliable backups of /etc/ and /home from multiple
# Debian/Ubuntu Linux systems. (May 10, 2019)
# (GNU/General Public License version 2.0)
#
# For Debian 9 and up, Ubuntu 16.04 and up and Linux Mint 18.x and up.

## Shellcheck Directives ##  (R. Romig)
# shellcheck source=/home/rick/bin/functionlib
# shellcheck disable=SC1091,SC2034

# Load function library (R. Romig)
# Adds check_package, die, user_in_sudo and format_time functions

if [[ -x "$HOME/bin/functionlib" ]]; then
  source "$HOME/bin/functionlib"
else
  printf "\e[91mERROR:\e[0m functionlib not found!\n" >&2
  exit 1
fi

# Declare static variables:
readonly _version="2.2"
readonly user=$USER
readonly host=$HOSTNAME

# Check for less and rsync, install if needed:

echo "Checking for dependencies..."
check_package rsync   # functionlib
check_package less    # functionlib

# Set functions:

drive_test() {
  # This function checks for a usable USB drive.

  # Checking for any USB drive:

  if [[ ! $(lsblk -S -o  TRAN | grep 'usb') = *usb* ]]; then
    printf "\nBU Error: No USB drive connected!\n" >&2
    printf " Check to see that BU_Drive is plugged in.\n" >&2
    printf " Please run 'bu --help' to learn about drive setup.\n" >&2
    exit 1
  fi

  # Checking for a USB drive that is setup for BU:

  if [[ ! -d /media/"$user"/BU_Drive ]]; then
    printf "\nBU Error: No USB drive with a partition labeled "BU_Drive!"\n" >&2
    printf " The drive(s) you have plugged in are not ready for use with BU.\n" >&2
    printf " Don't launch BU as root or with 'sudo bu.'\n" >&2
    printf " Please run 'bu --help' to learn about drive setup.\n" >&2
    exit 1
  fi

  # Check if the backup drive is mounted. (Romig)
  mounted=$(mount | grep 'BU_Drive')
  # if [ -z "$mounted" ]; then echo "BU_Drive is not mounted."; exit 1; fi
  [ -z "$mounted" ] && die "BU_Drive is not mounted." 1
}

backup() {

  # Check for sudo privileges:

  echo "Checking for sudo privileges..."
  user_in_sudo     # functionlib

  # Making sure user has ownership of the BU_Drive:

  printf "Changing ownership of BU_Drive to %s...\n" "$user"
  sudo chown "$user" /media/"${user}"/BU_Drive/

  # Creating machine specific directories:
  printf "Checking for/creating machine specific directories...\n"
  if mkdir -p /media/"$user"/BU_Drive/BU_Backups/"$host"; then
    printf "...Done. BU_Drive is ready.\n"
  else
    printf "\nBU Error: Could not create directory for %s!\n" >&2 "$host"
    printf "- Backup aborted. Check the status of the BU_Drive.\n" >&2
    exit 1
  fi

  # Run rsync command:
  # The '--exclude 'timeshift''  & 'if-then' added by R. Romig
  printf "Backing up /etc and /home to BU_Drive/BU_Backups/%s/...\n" "$host"
  if sudo rsync -aH --delete --exclude 'timeshift' --exclude '.local/share/libvirt/images' \
   --info=progress2 /etc /home /media/"$user"/BU_Drive/BU_Backups/"$host"/; then
    # Check for status of backup and exit:
    # [ "$?" == "0" ]; then
    # Clear any accidental input during backup:
    read -rt 1 -n 10000 discard

    box "All backed up!" "-"

    # Remove old and create new timestamp file:
    rm -f /media/"$user"/BU_Drive/BU_Backups/"$host"/BU\ Backup* >/dev/null 2>&1
    touch "/media/$user/BU_Drive/BU_Backups/$host/BU Backup was successful: $(date)"

    printf "Wait! Syncing Drives...\n"
    sync
    printf "...done\n"
    sudo umount /media/"$user"/BU_Drive && printf "BU_Drive unmounted.\n"
    printf "It's safe to remove the USB drive now.\n"
    printf "Backup completed in %s\n" "$(format_time $SECONDS)"
    exit
  else
    # Clear any accidental input during backup:
    read -rt 1 -n 10000 discard

    # Remove old and create new timestamp file:
    rm -f /media/"$user"/BU_Drive/BU_Backups/"$host"/BU\ Backup* >/dev/null 2>&1
    touch "/media/$user/BU_Drive/BU_Backups/$host/BU Backup had some errors: $(date)"

    printf "There were errors! Try running the command again to correct them.\n" >&2
    printf "- If errors persist then you may have corrupt files or failing hardware.\n" >&2
    sudo umount /media/"$user"/BU_Drive && printf "BU_Drive unmounted.\n"
    printf "It's safe to remove the USB drive now.\n"
    printf "Backup completed in %s\n" "$(format_time $SECONDS)"
    exit 1
  fi
}

restore() {

  # Runs an rsync operation to restore host's /home directory.

  # Check for the host's backup directory:

  if [[ ! -d /media/"$user"/BU_Drive/BU_Backups/"$host"/ ]]; then
    printf "BU Error: Cannot find valid backup directory for %s!\n" >&2 "$host"
    printf "- This drive may not have been used to backup this machine.\n" >&2
    printf "- BU_Backups/%s directory may have been moved or deleted.\n" >&2 "$host"
    printf "- Hostname or username may have changed since last backup.\n" >&2
    exit 1
  fi

  printf $'\n'$"\nBU Restore Function (Version 1.1)\n"
  printf $'\n'$"\nWARNING!\n"
  printf "Any new files created in /home since last backup WILL BE DELETED!\n"
  printf "Are you sure you want to restore now? [y/N]\n"
  read -rn 1 -s choice
  if [ "$choice" == "y" ]; then
    # Giving user a chance to close other apps and starting rsync.
    printf "Close any running applications and press any key to continue.\n"
    read -rn 1 -s
    printf $"\nRestoring /home... Please DO NOT open any applications.\n"
    # The '--exclude 'timeshift'' & 'if-then' added by R. Romig
    if sudo rsync -aH --delete --exclude 'timeshift' --info=progress2 \
      /media/"$user"/BU_Drive/BU_Backups/"$host"/home/ /home/; then
      # Prompt user to restart machine and exit:
      # Clear any accidental input during restore:
      read -rt 1 -n 10000 discard
      box " Restoration Complete!" "-"
      printf "Wait! Syncing drives...\n"
      sync
      printf "...Done."
      sudo umount /media/"$user"/BU_Drive && printf "BU_Drive unmounted.\n"
      printf "It's now safe to remove BU_Drive.\n"
      printf "Restart machine for all changes to take effect.\n"
      printf "Restore completed in %s\n" "$(format_time $SECONDS)"
      exit
    else
      # If rsync fails:
      # Clear any accidental input during restore:
      read -rt 1 -n 10000 discard
      printf "\nBU Error: rsync exited with errors!\n" >&2
      printf "DO NOT DO ANYTHING UNTIL YOU:\n" >&2
      printf $"\n    Make sure BU_Drive USB is still plugged in.\n" >&2
      printf "    Remount BU_Drive USB by unplugging it and plugging it back in.\n" >&2
      printf $'\n'$"Wait a few seconds and try running 'bu --restore' again.\n" >&2
      printf "You may need to manually restore your data if errors persist.\n" >&2
      sudo umount /media/"$user"/BU_Drive && printf "BU_Drive unmounted.\n"
      printf "It's now safe to remove BU_Drive.\n"
      exit 1
    fi
  else
    printf "Restoration canceled.\n"
    sudo umount /media/"$user"/BU_Drive && printf "BU_Drive unmounted.\n"
    printf "It's now safe to remove BU_Drive.\n"
    exit
  fi
}

help() {

# Print help information using less utility:

less << EOF

 BU - USB Backup Tool (Version $_version) -- Help

 Press "q" to exit this Help page.

 Commands:

 bu = Fully backs up host's /etc and /home directories to BU_Drive.
 bu --help = Prints this help information.
 bu --restore = Accesses BU Restore function.

 Description:

 BU is a program that makes keeping all of your user data safely backed up on
 a dedicated External USB drive easy.

 BU will update files that have changed, remove files that have been
 deleted and add any new files that have been created since the last backup.
 The initial backup can take a lot of time if you have a lot of data stored
 in your system's /home directory. BU creates a directory with the host name
 of the machine it's backing up from inside BU_Backups. This allows users to
 share one BU_Drive with multiple machines.

 The directory structure and all files are stored openly to allow users easy
 access if they only need to retrieve a few files or directories using a file
 manager.

 The BU Restore function is an interactive tool that let's users restore their
 /home directories to a backup up state. This function will only work when
 restoring to a machine with the exact same hostname as the one the backs were
 made from. It is intended for emergency use, as when significant number of
 directories and files are accidentally removed from /home.

 BU_Drive Setup

 You need to prepare a BU Drive with a tool like Gparted or Disks.
 This can be any USB storage device. The dedicated USB drive MUST contain a
 partition formatted with a Linux native file system such as Ext4 or XFS. The
 partition MUST be labeled "BU_Drive" so BU can find it and use it for backups.
 The partition needs to have enough free capacity to store all data in /home on
 all of the machines you want to use the drive for. Note: You will get many
 errors if you attempt to use BU to backup to a partition that is formatted with
 non-native file systems like FAT32 or NTFS.

 Disclaimer:

 THIS SOFTWARE IS PROVIDED BY EZEELINUX “AS IS” AND ANY EXPRESS OR IMPLIED
 WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF
 MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO
 EVENT SHALL EZEELINUX BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,
 EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,
 PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR
 BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER
 IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
 ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE
 POSSIBILITY OF SUCH DAMAGE.

EOF
}

# Execution.

# Start timer (Added by R. Romig)
SECONDS=0

# Checking for command line arguments:
# Double brackets for conditinoal statements added by R. Romig
if [[ "$1" == "--help" ]]; then
	help
	exit
elif [[ "$1" == "--restore" ]]; then
	drive_test
	restore
elif  [[ -n "$1" ]]; then
  printf "BU Error: Invalid argument.\n" >&2
  printf "- Try 'bu --help' to see the available commands.\n" >&2
  exit 1
fi

box "BU -- USB Backup Tool (Version $_version)"
drive_test
backup
