#!/usr/bin/env bash
###############################################################################
# Script Name  : odt-to-txt
# Description  : Convert .odt files to .txt or .md files
# Dependencies : odt2txt
# Arguments    : None
# Author       : Copyright (C) 2019, Richard B. Romig, 10 May 2019
# Email        : rick.romig@gmail.com | rick.romig@mymetronet.net
# Comments     : Run from adirectory containing files to be converted.
# TODO (rick)  :
# License      : GNU General Public License, version 2.0
###############################################################################

## Shellcheck Directives ##
# shellcheck source=/home/rick/bin/functionlib

## Load function library ##

if [[ -x "$HOME/bin/functionlib" ]]; then
  source "$HOME/bin/functionlib"
else
  echo -e "\e[91mERROR:\e[0m functionlib not found!" >&2
  exit 1
fi

## Variables ##

_script=$(basename "$0"); readonly _script
readonly _version="1.4.24231"

## Functions ##

convert2txt() {
  local odt_file txt_file
  odt_file=$1
  txt_file="${odt_file%%.*}.txt"
  /usr/bin/odt2txt "$odt_file" > "$txt_file"
  echo "$odt_file -> $txt_file"
}

convert2md() {
  local odt_file md_file
  odt_file=$1
  md_file="${odt_file%%.*}.md"
  /usr/bin/odt2txt "$odt_file" > "$md_file"
  echo "$odt_file -> $md_file"
}

ls_odt_files() {
  ls ./*.odt > /dev/null 2>&1 || diehard "No .odt files found." "Change to a directory containing .odt files."
  echo -e "Available .odt filse in $PWD:\n"
  find ./ -maxdepth 1 -type f -name "*.odt" | sed 's/\.\///' | sort
}

## Execution ##

check_package odt2txt

# Disable Crtl+C
trap '' 2

while true; do
  clear
  echo "$_script v$_version"
  under_line "Converts *.odt files to *.txt or *.md" "*"
  ls_odt_files
  echo
  under_line "Use with care. May overwrite existing .txt or .md files." "*"
  COLUMNS=12
  echo $'\n'$"Available operations:"
  options=("Convert a single .odt file to .txt" "Convert a single .odt file to .md" \
    "Convert all .odt files to .txt" "Convert all .odt files to .md" "Quit and exit")
  PS3="Choose an option: "
  select _opt in "${options[@]}"; do
    case $REPLY in
      1 )
        read -rp "File to convert: " ofile
        if [[ -f "$ofile" ]]; then
          echo "Converting *.odt to *.txt"
          convert2txt "$ofile"
        else
          echo "${lightred}Error:${normal} $ofile not found." >&2
        fi
        anykey; break
      ;;
      2 )
        read -rp "File to convert: " ofile
        if [[ -f "$ofile" ]]; then
          echo "Converting *.odt to *.md"
          convert2md "$ofile"
        else
          echo "${lightred}Error:${normal} $ofile not found." >&2
        fi
        anykey; break
      ;;
      3 )
        echo "Converting *.odt to *.txt"
        for ofile in *.odt; do
          convert2txt "$ofile"
        done
        anykey; break
      ;;
      4 )
        echo "Converting *.odt to *.md"
        for ofile in *.odt; do
          convert2md "$ofile"
        done
        anykey; break
      ;;
      5 )
        trap 2
        leave "All done! Exiting the script."
      ;;
      * )
        echo "${lightred}Invalid Option!${normal} Choose 1 - 5" >&2
    esac
  done
done
