#!/usr/bin/env bash
###############################################################################
# Script Name  : insert-header
# Description  : Insert a header into a shell script or C source code.
# Dependencies : bat, micro (used by edit_view_quit.)
# Arguments    : see help(). Shell script or C/C++ source file
# Author       : Copyright (C) 2019, Richard B. Romig, Mosfanet
# Email        : rick.romig@gmail.com | rick.romig@mymetronet.net
# Created      : 05 Jun 2019
# Updated      : 25 Jun 2025
# Comments     : Assumes first line of the target file is either a hash-bang or a C/C++ comment
# TODO (rick)  :
# License      : GNU General Public License, version 2.0
###############################################################################

## Shellcheck Directives ##
# shellcheck source=/home/rick/bin/functionlib

## Load function library ##

if [[ -x "$HOME/bin/functionlib" ]]; then
  source "$HOME/bin/functionlib"
else
  echo -e "\e[91mERROR:\e[0m functionlib not found!" >&2
  exit 1
fi

## Global Variables ##

readonly script="${0##*/}"
readonly version="4.2.25176"
verbose_mode="$FALSE"

## Functions ##

help() {
  local errcode="${1:-2}"
  local updated="25 Jun 2025"
  cat << _HELP_
${orange}$script${normal} $version ($updated)
Inserts a header into a shell script or a C/C++ source file.

${green}Usage:${normal} $script [-h] [-vc c-source-file] [-vp cpp-source-file] [-vs shell-script]

${orange}Available options:${normal}
  -c  Insert C code header
      $script -c <c-source.c>
  -h  Show this help message and exit
  -p  Insert C++ code header
      $script -p <cpp-source.cpp>
  -s  Insert Shell script header
      $script -s <shell-script>
  -v  Enable verbose mode (Must precede -c, -p, or -s flags)
      $script -vs <shell-script>
_HELP_
  exit "$errcode"
}

show_message() {
	local message="$1"
	[[ "$verbose_mode" == "$TRUE" ]] && echo "$message"
}

# shellcheck disable=SC2317 # Don't warn about unreachable commands in this function
# ShellCheck may incorrectly believe that code is unreachable if it's invoked by variable name or in a trap.
cleanup() {
	show_message "Removing temporary file."
  [[ -f "$tmp_file" ]] && rm -f "$tmp_file"
}

create_tmp_file() {
	show_message "Creating temporary file."
	tmp_file=$(mktemp -q) || die "Failed to create temporary file." 1
	trap cleanup EXIT
}

insert_header() {
	local coder code_file code_type cur_yr copy_holder email_addr email_addr1 work_org today license template_dir template_file
	code_file="$1"
	code_type="$2"
	template_file="$3"
	coder="Rick"
	copy_holder="Richard B. Romig"
	email_addr="rick.romig@gmail.com"
	email_addr1="rick.romig@mymetronet.com"
	work_org="Mosfanet"
	license="GNU General Public License, version 2.0"
	today=$(date +"%d %b %Y")
	cur_yr=$(echo -e "\UA9 $(date +%Y)")
	template_dir="$HOME/bin/Templates"

	show_message "Inserting $code_type header into $code_file."
	case $code_type in
    "C"|"C++" )
      sed -e '1d' \
        -e "s/<PROGNAME>/$code_file/" \
        -e "s/<YEAR>/$cur_yr/" \
        -e "s/<AUTHOR>/$copy_holder/" \
        -e "s/<ADDR>/$email_addr/" \
        -e "s/<ADDR1>/$email_addr1/" \
        -e "s/<ORG>/$work_org/" \
        -e "s/<TODAY>/$today/" \
        -e "s/<LICENSE>/$license/" "$template_dir/$template_file" > "$tmp_file"
      sed -i -e "1r ${tmp_file}" "$code_file"
      ;;
    "Shell" )
	    sed -e '1d' \
        -e "s/<FILE>/$code_file/" \
        -e "s/<YEAR>/$cur_yr/" \
        -e "s/<AUTHOR>/$copy_holder/" \
        -e "s/<EMAIL>/$email_addr/" \
        -e "s/<EMAIL1>/$email_addr1/" \
        -e "s/<ORG>/$work_org/" \
        -e "s/<TODAY>/$today/" \
        -e "s/<CODER>/$coder/" \
        -e "s/<LICENSE>/$license/" "$template_dir/$template_file" > "$tmp_file"
      sed -i -e "1r ${tmp_file}" "$code_file"
      ;;
    * )
      printf "%sInvalid code type.%s\n" "$lightred" "$normal" >&2
	esac

	printf "The %s header has been inserted into %s." "$code_type" "$code_file"
}

main() {
	local code_file code_type template_file noOpt opt optstr
	noOpt=1
	optstr=":c:hp:s:v"
	while getopts "$optstr" opt; do
    case "$opt" in
      c )
				code_file="$OPTARG"
				[[ -f "$code_file" ]] || { printf "%s %s not found\n" "$RED_ERROR" "$code_file" >&2; help 2; }
        show_message "File: $code_file"
        code_type="C"
        show_message "Code type: $code_type header"
        template_file="c-header.txt"
        show_message "Template: $template_file"
        create_tmp_file
        ;;
      h )
        help 0
        ;;
      p )
				code_file="$OPTARG"
				[[ -f "$code_file" ]] || { printf "%s %s not found\n" "$RED_ERROR" "$code_file" >&2; help 2; }
        show_message "File: $code_file"
        code_type="C++"
        show_message "Code type: $code_type header"
        template_file="cpp-header.txt"
        show_message "Template: $template_file"
        create_tmp_file
        ;;
      s )
				code_file="$OPTARG"
				[[ -f "$code_file" ]] || { printf "%s %s not found\n" "$RED_ERROR" "$code_file" >&2; help 2; }
        show_message "File: $code_file"
        code_type="Shell"
        show_message "Code type: $code_type header"
        template_file="bash-header.txt"
        show_message "Template: $template_file"
        create_tmp_file
        ;;
			v )
				verbose_mode="$TRUE"
				show_message "Verbose mode enabled."
			  ;;
      : )
        printf "%s Must supply an argument to -%s.\n" "$RED_ERROR" "$OPTARG" >&2
        help 2
        ;;
      ? )
				printf "%s Invalid option -%s\n" "$RED_ERROR" "$OPTARG" >&2
				help 2
    esac
		noOpt=0
	done
	[[ "$noOpt" = 1 ]] && { printf "%s No argument passed.\n" "$RED_ERROR" >&2; help 1; }
	shift "$(( OPTIND - 1 ))"
	[[ "$code_file" ]] || { printf "%s No code file provided.\n" "$RED_ERROR" >&2; help 2; }
	insert_header "$code_file" "$code_type" "$template_file"
	edit_view_quit "$code_file"
	over_line "$script $version"
	printf "MOTD: "; leave ""
}

## Execution ##

main "$@"
