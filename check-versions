#!/usr/bin/env bash
##########################################################################
# Script Name  : check-versions
# Description  : Checks GitHub for latest versions of select programs and
#              : displays latest versions with currently installed versions.
# Dependencies : curl
# Arguments    : none
# Author       : Richard B. Romig, 24 Aug 2021
# Email        : rick.romig@gmail.com
# Comments     : Apps checked: atom, bat, ddgr, glow, marktext, micro, vscodium
#              : Ignores Beta and Release Candidate versions in GitHub releases.
# 24 Feb 2022  : Adjustment for package & new version >= 8 characters.
# 01 Mar 2022  : Fixed new_ver function to get 7th field of download URL.
# 10 Mar 2022  : Formatted output using printf width specifiers.
# 12 May 2022  : added sed command to current version routine for micro.
# 16 May 2022  : added sed command to current version routine for bat & glow.
# 20 Jun 2022  : added Atom Editor to applications to check.
# 16 Jul 2022  : added VSCodium Editor to applications to check.
# 17 Aug 2022  : modified prntf width specifiers to allow longer version numbers.
# 28 Aug 2022  : modified variables for GitHub releases URLs.
# 11 Sep 2022  : added Cascadia-Code-fonts to applications to check.
# 12 Sep 2022  : removed Cascadia-Code-Fonts and Stacer from applications to check.
# 13 Sep 2022  : removed ddgr and glow from applications to check.
# 30 Sep 2022  : moved script, version, update variables to main function.
# TODO (Rick)  :
# License      : GNU General Public License, version 2.0
##########################################################################

## Shellcheck Directives ##
# shellcheck source=/home/rick/bin/functionlib
# shellcheck disable=SC1091

## Source function library ##

if [[ -x "$HOME/bin/functionlib" ]]; then
  source "$HOME/bin/functionlib"
else
  printf "\e[91mERROR:\e[0m functionlib not found!\n" >&2
  exit 1
fi

## Functions ##

check_dependencies() {
	check_package curl
}

cleanup() {
	[[ -f "$tmp_file" ]] && rm -f "$tmp_file"
}

get_versions() {
  local package="$1"
  local github_url="https://github.com"

  # Set URL of GitHub repoository and currently installed version of package.
  case "$package" in
    "bat" )
      local release_path="sharkdp/bat/releases"
      cur_ver=$(dpkg -l | awk '$2 == "bat" {print $3}' | sed 's/[+-].*//') ;;
    "micro" )
      local release_path="zyedidia/micro/releases"
      cur_ver=$(dpkg -l | awk '$2 == "micro" {print $3}' | sed 's/[+-].*//') ;;
    "marktext" )
      local release_path="marktext/marktext/releases"
      cur_ver=$(dpkg -l | awk '$2 == "marktext" {print $3}' | sed 's/[+-].*//') ;;
    "atom" )
      local release_path="atom/atom/releases"
      cur_ver=$(dpkg -l | awk '$2 == "atom" {print $3}' | sed 's/[+-].*//') ;;
		"vSCodium" )
			local release_path="VSCodium/vscodium/releases"
			cur_ver=$(dpkg -l | awk '$2 == "codium" {print $3}' | sed 's/[+-].*//') ;;
   * )
      die "Invalid package name - ${package,,}." 2 ;;
  esac

  # Extract newest version number from the package releases web page on GitHub.
  # Ignore beta and release candidate releases.
  curl -s -o "$tmp_file" "$github_url/$release_path"
  new_ver=$(sed 's/\// /g' "$tmp_file" | grep -Ev 'beta|-rc' | awk '/download/ && /amd64.deb/ {print $7;exit}' | sed 's/^v//')
  # Print capitalized package name
  printf "${darkgray}%-15s${normal}" "${package^}"
  # Print newest version
  printf "${gray}%-16s${normal}" "$new_ver"
  # Print current (installed) version (orange text indicates update available)
  if [[ -z "$cur_ver" ]]; then
    printf "${red}not installed${normal}\n"
  elif [[ "$new_ver" == "$cur_ver" ]]; then
    printf "${gray}%s${normal}\n" "$cur_ver"
  else
    printf "${orange}%s${normal}\n" "$cur_ver"
  fi
}

main() {
  local _script=$(basename "$0")
  local _version="0.6.14"
  local _updated="30 Sep 2022"
  local packages=( atom bat marktext micro vSCodium )
  clear
  printf "\U1F427 %s v%s (%s)\n" "$_script" "$_version" "$_updated"
  printf "Newest & installed versions of select programs.\n\n"
  printf "${underline}%-15s%-16s%s${normal}\n" "Program" "Latest version" "Installed version"
  for pkg in "${packages[@]}"; do get_versions "$pkg"; done
  printf "\n"
  leave ""
}

## Execution ##

check_dependencies
tmp_file=$(mktemp -q) || die "Failed to create temporary file." 1
trap cleanup EXIT
main
