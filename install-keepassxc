#!/usr/bin/env bash
##########################################################################
# Script Name  : install-keepassxc
# Description  : Installs/removes KeePassXC from Flathub or distro repos
# Dependencies : none
# Arguments    : -d -f -h -m -r (see help function)
# Author       : Copyright (C) 2021, Richard B. Romig, 26 Jan 2021
# Email        : rick.romig@gmail.com | rick.romig@mymetronet.net
# Created      : 26 Jan 2021
# Updated      : 09 May 2024
# Comments     :
# TODO (Rick)  :
# License      : GNU General Public License, version 2.0
##########################################################################

## Shellcheck Directives ##
# shellcheck source=/home/rick/bin/functionlib

## Load function library ##

if [[ -x "$HOME/bin/functionlib" ]]; then
  source "$HOME/bin/functionlib"
else
  echo -e "\e[91mERROR:\e[0m functionlib not found!" >&2
  exit 1
fi

## Variables ##

_script=$(basename "$0"); readonly _script
readonly _version="3.10.24130"
readonly _updated="09 May 2024"

## Functions ##

kpxc_ver() {
  dpkg -l | awk '$2 == "keepassxc" {print $3}' | sed 's/[+-].*//'
}

keepass_ver() {
  flatpak list | awk '/KeePassXC/ {print $3}'
}

flathub_keepassxc() {
  sudo_login 2
  sudo flatpak remote-add --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo
  flatpak install --user flathub org.keepassxc.KeePassXC
  printf "KeePassXC %s installed from flathub.\n" "$(keepass_ver)"
}

distro_keepassxc() {
  sudo_login 2
  sudo apt-get install keepassxc -yy
  printf "Keepassxc %s installed from distro repositories.\n" "$(kpxc_ver)"
}

remove_flatpak_keepassxc() {
  printf "Removing the KeePassXC flatpak...\n"
  [[ -d "HOME/.var/app/org.keepassxc.KeePassXC" ]] && flatpak uninstall --noninteractive --assumeyes org.keepassxc.KeePassXC
  printf "KeePassXC flatpak removed.\n"
}

remove_distro_keeepassxc() {
  sudo_login 2
  printf "Removing the KeePassXC DEB package...\n"
  sudo apt-get remove --purge keepassxc -yy
  [[ -d "$HOME/.config/keepassxc" ]] && rm -rf "$HOME/.config/keepassxc"
  [[ -d "$HOME/.config/backup/keepassxc" ]] && rm -rf "$HOME/.config/backup/keepassxc"
  printf "KeePassXC DEB package removed.\n"
}

move_vault() {
  local vault_dir="$HOME/Documents"
  printf "Moving password databases to ~/Documents...\n"
  find "$HOME/Documents/mosfanet/" -maxdepth 1 -type f -iname "*.kdbx" -print -exec mv {} "$vault_dir/" \;
}

help() {
  errcode="${1:-2}"
  cat << END_HELP
Usage: $_script [OPTIONS]
OPTIONS:
  -d  Install KeePassXC from distribution repositories.
  -f  Install KeePassXC from flathub repositories.
  -h  Display help.
  -m  Move password vaults from ~/Documents/mosfanet to ~/Documents.
  -r  Remove KeePassXC from the system.
$_script v$_version (Updated $_updated)
END_HELP
  exit "$errcode"
}

## Execution ##

box "$_script v$_version"
echo "Installs KeePassXC password manager"
noOpt=1
optstr=":dfhmr"
while getopts "$optstr" opt; do
  case "$opt" in
    d )
      if exists keepassxc; then
        printf "KeePassXC version %s is already installed from distro.\n" "$(kpxc_ver)"
      elif  flatpak list | grep -qw KeePassXC; then
        printf "KeePassXC %s is already installed from flatpak.\n" "$(keepass_ver)"
      else
        distro_keepassxc
      fi
    ;;
    f )
      if exists keepassxc; then
        printf "KeePassXC version %s is already installed from distro.\n" "$(kpxc_ver)"
      elif  flatpak list | grep -qw KeePassXC; then
        printf "KeePassXC %s is already installed from flatpak.\n" "$(keepass_ver)"
      else
        flathub_keepassxc
      fi
    ;;
    h )
      help 0
    ;;
    m )
      move_vault
    ;;
    r )
      if flatpak list | grep -qw KeePassXC; then
        remove_flatpak_keepassxc
      elif exists keepassxc; then
        remove_distro_keeepassxc
      else
        leave "KeePassXC is not installed."
      fi
    ;;
    ? )
      printf "%s Invalid option -%s\n" "$red_error" "$OPTARG" >&2
      help 2
  esac
	noOpt=0
done
[[ "$noOpt" = 1 ]] && { printf "%s No argument passed.\n" "$red_error" >&2; help 1; }
shift "$(( OPTIND - 1 ))"
exit
