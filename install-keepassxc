#!/usr/bin/env bash
##########################################################################
# Script Name  : install-keepassxc
# Description  : Installs/removes KeePassXC from Flathub or distro repos
# Dependencies : wget
# Arguments    : -c -d -f -h -r (see help function)
# Author       : Copyright (C) 2021, Richard B. Romig, LudditeGeek
# Email        : rick.romig@gmail.com | rick.romig@mymetronet.net
# Created      : 26 Jan 2021
# Updated      : 03 Feb 2026
# Comments     :
# TODO (Rick)  :
# License      : GNU General Public License, version 2.0
# License URL  : https://github.com/RickRomig/scripts/blob/main/LICENSE
##########################################################################
# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; either version 2 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
# GNU General Public License for more details.
##########################################################################

## Shellcheck Directives ##
# shellcheck source=/home/rick/bin/functionlib

## Load function library ##

if [[ -x "$HOME/bin/functionlib" ]]; then
  source "$HOME/bin/functionlib"
else
  echo -e "\e[91mERROR:\e[0m functionlib not found!" >&2
  exit 81
fi

## Global Variables ##

readonly script="${0##*/}"
readonly version="4.5.26034"
EC=0

## Functions ##

help() {
	local errcode="${1:-1}"
	local updated="303 Feb 2026"
	cat << _HELP_
${orange}$script${normal} $version ($updated)
Installs/Removed KeePassXC password manager

${green}Usage:${normal} $script [-dfhr]
${orange}Available options:${normal}
  -c  Apply KeeePassXC configuration.
  -d  Install KeePassXC from distribution repositories.
  -f  Install KeePassXC from flathub repositories.
  -h  Show this help message and exit.
  -r  Remove KeePassXC from the system.
_HELP_
  exit "$errcode"
}

flatpak_keepassxc() {
  exists flatpak || return "$FALSE"
  grep -qw KeePassXC <(flatpak list) && return "$TRUE" || return "$FALSE"
}

keepass_version() {
  if exists keepassxc; then
    awk '{print $NF}' <(keepassxc --version)
  elif flatpak_keepassxc; then
    awk '/KeePassXC/ {print $(NF-2)}' <(flatpak list)
  fi
}

install_flathub_keepassxc() {
  sudo_login 2
  sudo flatpak remote-add --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo
  flatpak install --user flathub org.keepassxc.KeePassXC
  if grep -qw KeePassXC <(flatpak list); then
    printf "%s KeePassXC installation failed.\n" "$RED_ERROR" >&2
    EC="$E_INSTALLATION"
    return
  fi
  printf "KeePassXC %s installed from flathub.\n" "$(keepass_version)"
  apply_keepassxc_ini
}

install_distro_keepassxc() {
  sudo_login 2
  sudo apt-get install keepassxc -yy
  if grep -q '^ii' <(dpkg -l keepassxc 2>/dev/null); then
    printf "%s KeePassXC installation failed.\n" "$RED_ERROR" >&2
    EC="$E_INSTALLATION"
    return
  fi
  printf "Keepassxc %s installed from distro repositories.\n" "$(keepass_version)"
  apply_keepassxc_ini
}

remove_flatpak_keepassxc() {
  printf "Removing the KeePassXC flatpak...\n"
  flatpak uninstall --noninteractive --assumeyes org.keepassxc.KeePassXC
  rm -rf ~/.var/app/org.keepassxc.KeePassXC
  printf "KeePassXC flatpak removed.\n"
}

remove_distro_keeepassxc() {
  sudo_login 2
  printf "Removing KeePassXC ...\n"
  sudo apt-get remove --purge keepassxc -yy
  find ~/ -maxdepth 3 -type d -path "$HOME/Downloads" -prune -o -path "$HOME/gitea" -prune -o -type d -name keepassxc -exec rm -rf {} \;
  printf "KeePassXC removed.\n"
}

apply_keepassxc_ini() {
  local repository=~/Downloads/configs/keepassxc
  [[ -d ~/gitea/configs/keepassxc ]] && repository=~/gitea/configs/keepassxc
  if [[ ! -d "$repository" ]]; then
    printf "%s Configs repository not found!\n" "$RED_WARNING" >&2
    EC="$E_FILENOTFOUND"
    return
  fi
  local -r ini_file="keepassxc.ini"
  local cfg_dir=~/.config/keepassxc
  flatpak_keepassxc && cfg_dir=~/.var/app/org.keepassxc.KeePassXC/config
  [[ -d "$cfg_dir" ]] || mkdir -p "$cfg_dir"
  printf "Applying %s ...\n" "$ini_file"
  cp -v "$repository/$ini_file" "$cfg_dir/"
  printf "%s applied.\n" "$ini_file"
}

main() {
  local noOpt opt optstr OPTARG OPTIND
  noOpt=1
  optstr=":cdfhr"
  while getopts "$optstr" opt; do
    case "$opt" in
      c )
        if exists keepassxc || flatpak_keepassxc; then
          apply_keepassxc_ini
        fi
        ;;
      d )
        if exists keepassxc || flatpak_keepassxc; then
          printf "KeePassXC version %s is already installed.\n" "$(keepass_version)"
        else
          install_distro_keepassxc
        fi
        ;;
      f )
        if exists keepassxc || flatpak_keepassxc; then
          printf "KeePassXC version %s is already installed.\n" "$(keepass_version)"
        else
          install_flathub_keepassxc
        fi
        ;;
      h )
        help 0
        ;;
      r )
        if flatpak_keepassxc; then
          remove_flatpak_keepassxc
        elif exists keepassxc; then
          remove_distro_keeepassxc
        else
          printf "KeePassXC is not installed.\n"
        fi
        ;;
      ? )
        printf "%s Invalid option -%s\n" "$RED_ERROR" "$OPTARG" >&2
        help  "$E_INVALID_ARG"
    esac
	  noOpt=0
  done
  [[ "$noOpt" = 1 ]] && { printf "%s No argument passed.\n" "$RED_ERROR" >&2; help "$E_MISSING_ARG"; }
  shift "$(( OPTIND - 1 ))"
  over_line "$script $version"
  exit "$EC"
}

## Execution ##

main "$@"
