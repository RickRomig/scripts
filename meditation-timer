#!/usr/bin/env bash
##########################################################################
# Script Name  : meditation-timer
# Description  : Counts down remaining time of a meditation session.
# Dependencies : aplay (ALSA)
# Arguments    : Time in minutes to cound down from.
# Author       : Copyright (C) 2021, Richard B. Romig, ludditeGeek@Mosfanet
# Email        : rick.romig@gmail.com | rick.romig@mymetronet.net
# Created      : 06 Jul 2021
# Updated      : 06 Jun 2024
# Comments     : Original script found on Reddit r/dharmmawheel, posted by u/Jhanna4
# TODO (Rick)  : get_volume() and set_volume()
# License      : GNU General Public License, version 2.0
##########################################################################

## Shellcheck Directives ##
# shellcheck source=/home/rick/bin/functionlib

## Load function library ##

if [[ -x "$HOME/bin/functionlib" ]]; then
  source "$HOME/bin/functionlib"
else
  printf "\e[91mERROR:\e[0m functionlib not found!\n" >&2
  exit 1
fi

## Global Variables ##

_script=$(basename "$0"); readonly _script
readonly _version="4.2.24158"
readonly med_time="${1:-20}"
readonly sound_dir="$HOME/bin/files"
readonly sound_one="Tibetan_bowl.wav"
# readonly sound_two="Low-Wood-Block.wav"

## Functions ##

input_value() {
  printf "%s Invalid argument\n" "$red_error" >&2
  printf "Please supply a value for minutes, only minutes, and only whole numbers greater than 0.\n" >&2
  exit 2
}

get_volume() {
  local mixer
  mixer=$(amixer get Master | grep 'Mono:')
  echo "$mixer" | awk '{print $3}'
}

set_volume() {
  amixer cset iface=MIXER,name="Master Playback Volume" "$1" >/dev/null
}

play_sound() {
  # Play a sound as a background process.
  local sound="$1"
  /usr/bin/aplay "$sound" > /dev/null 2>&1 &
}

screensaver_off() {
  # Turn off screensaver and hide cursor.
  xset s off
  xset s noblank
  xset -dpms
  tput civis
}

screensaver_on() {
  # Turn screensaver back on and restore cursor.
  xset s on
  xset s blank
  xset +dpms
  tput cnorm
}

countdown() {
  for i in {10..1}; do printf "\t%02d\r" "$i"; sleep 1; done
}

main_timer() {
  local hours interval min minutes seconds sec_rem
  min="$1"
  sec_rem=$(( 60 * min ))
  while [[ "$sec_rem" -gt 0 ]]; do
    sec_rem=$(( sec_rem - 1 ))
    interval="$sec_rem"
    seconds=$(( interval % 60 ))
    interval=$(( interval - seconds ))
    minutes=$(( interval % 3600 / 60 ))
    interval=$(( interval - minutes ))
    hours=$(( interval % 86400 / 3600 ))
    # interval=$(( interval - hours ))
    # days=$(( interval % 604800 / 86400 ))
    # interval=$(( interval - hours ))
    # weeks=$(( interval / 604800 ))
    printf "\t%02d:%02d:%02d\r" "$hours" "$minutes" "$seconds"
    # [[ $(( sec_rem % 300 )) -eq 0 && "$sec_rem" -gt 0 ]] && play_sound "$sound_dir/$sound_two"
    sleep 1
  done
}

## Execution ##

[[ -n ${med_time//[0-9]/} || "$med_time" -eq 0 ]] && input_value
# trap 'screensaver_on' SIGINT
clear
# Capture original volume setting
# ovol=$(get_volume)
# Set playback volume
# vol=50; set_volume "$vol"
printf "\n\t\U2638 Meditation Timer \U2638 \n\n"
screensaver_off
countdown
play_sound "$sound_dir/$sound_one"
main_timer "$med_time"
play_sound "$sound_dir/$sound_one"
sleep 30
screensaver_on
# set_volume "$ovol"
printf "\n\n\U2638 %s v%s\n" "$_script" "$_version"
printf "\UA9 2021-2024 Richard B. Romig\n"
exit
