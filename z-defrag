#!/usr/bin/env sh

set -e

# Script to check defrag condition on spinning drives.
# Will not run e4defrag on SSD or NVME drives.
# Run as root user.
# Place in /etc/cron.monthly/ for anacron jobs.
# Place in /usr/local/bin/ or /opt/bin/ for cron jobs.
# Last updated: 04 Nov 2023
# Version 1.2.4
# Copyright (C) 2021-2023, Richard B. Romig
# License : GNU General Public License, version 2.0

log_dir="/var/log"
log_file="defrag.log"
host_name=$(/usr/bin/uname -n)

{
	printf "Defrag Report: %s\n\n" "$(date '+%a %F %R')"
	case "$host_name" in
		hp-800-g1-usdt|hp-probook-6570|e-475m|hp-mini-110 )
			printf "SSD - e4defrag not run.\n"
		;;
		hp-860-g3 )
			printf "NVMe - e4defrag not run,\n"
		;;
		hp-6005 )
			/usr/sbin/e4defrag -c / /home /data
		;;
		hp-800g2-sff )
			# e4defrag not run on /dev/sda (SSD)
			/usr/sbin/e4defrag -c /home
		;;
		* )
			/usr/sbin/e4defrag -c / /home
	esac
	printf "\n"
} > "$log_dir/$log_file" 2>&1
if [ -f "$log_dir/$log_file" ]; then
	sed -i '/^e4defrag/d;/0-30/d;/^ Done/d' "$log_dir/$log_file"
fi
exit
