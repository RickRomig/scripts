#!/usr/bin/env sh

set -e

# Script to defrag / and /home partitions.
# Do not run on an SSD.
# Place in /etc/cron.monthly/ for anacron.
# Place in /usr/local/bin/ or /opt/bin/ for cron.
# Last updated: 27 Jan 2023
# License : GNU General Public License, version 2.0

log_dir="/var/log"
log_file="defrag.log"
host_name=$(/usr/bin/uname -n)

{
  printf "Defrag log: %s\n\n" "$(date '+%a %F %R')"
  case "$host_name" in
    e-475m|hp-mini-110 )
      printf "sda is an SSD, defrag not run.\n"
      ;;
	  hp-850-g3 )
			printf "NVMe - defrag not run.\n"
			;;
		hp-6005 )
		  /usr/sbin/e4defrag -c / /home /data
		  ;;
	  hp-800g2-sff )
		  printf "sda is an SSD, defrag not run.\n\n"
		  /usr/sbin/e4defrag -c /home
		  ;;
	  * )
	    /usr/sbin/e4defrag -c / /home
		  ;;
  esac
	printf "\n"
} > "$log_dir/$log_file" 2>&1
# Cleanup log file.
sed -i '/^e4defrag/d;/0-30/d;/^ Done/d' "$log_dir/$log_file"
exit
