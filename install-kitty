#!/usr/bin/env bash
##########################################################################
# Script Name  : install-kitty
# Description  : Installs kitty terminal emulator with basic configuration.
# Dependencies : None
# Arguments    : -c -h -i -p -r (see help function for more information)
# Author       : Copyright (C) 2022, Richard B. Romig, 26 Sep 2022
# Email        : rick.romig@gmail.com | rick.romig@mymetronet.net
# Comments     : Configures as login terminal for Debian-based distros.
# TODO (Rick)  :
# License      : GNU General Public License, version 2.0
##########################################################################

## Shellcheck Directives ##
# shellcheck source=/home/rick/bin/functionlib
# shellcheck disable=SC1091

## Source function library ##

if [[ -x "$HOME/bin/functionlib" ]]; then
  source "$HOME/bin/functionlib"
else
  printf "\e[91mERROR:\e[0m functionlib not found!\n" >&2
  exit 1
fi

## Variables ##

_script=$(basename "$0"); readonly _script
readonly _version="0.2.4"
readonly _updated="28 Sep 2023"
readonly kitty_cfg="$HOME/.config/kitty"

## Functions ##

help() {
  local errcode="${1:-2}"
  cat << END_HELP
${green}Usage:${normal} $_script [OPTION]
${orange}Options:${normal}
  -b  Copy Kitty keybindings list
  -c  Install Kitty configuration
  -h  Display help
  -i  Install Kitty from distro repositories
  -p  Purge Kitty from system (remove config files)
  -r  Remove Kitty from system (leave config files)
END_HELP
	printf "%s v%s (%s)\n" "$_script" "$_version" "$_updated"
  exit "$errcode"
}

kitty_version() {
  kitty --version | awk '{print $2}'
}

install_kitty() {
  printf "Installing the kitty terminal emulator.\n"
  sudo apt-get install kitty imagemagick -yy
  kitty_config
  kitty_bindings
  printf "Kitty %s installed and configured.\n" "$(kitty_version)"
}

remove_kitty() {
  printf "Removing the Kitty terminal emulator %s\n" "$(kitty_version)"
  sudo apt-get remove kitty -yy
  printf "The Kitty terminal emulator has been uninstalled.\n"
}

purge_kitty() {
  printf "Purging the Kitty terminal emulator %s\n" "$(kitty_version)"
  sudo apt-get purge kitty -yy
  find "$HOME/.config/" -maxdepth 3 -type d -name "kitty" -exec rm -rf {} \;
  find "$HOME/.cache/" -maxdepth 2 -type d -name "kitty" -exec rm -rf {} \;
  printf "The Kitty terminal emulator and configuration files have been removed.\n"
}

kitty_config() {
  # local files_dir="$HOME/bin/files"
  # local doc_kitty="/usr/share/doc/kitty/examples"
  local gitea_url="http://192.168.0.16:3000/Nullifidian/configs/raw/branch/main/kitty"
  printf "Setting up kitty.conf ...\n"
  [[ -d "$kitty_cfg" ]] || mkdir -p "$kitty_cfg"
  curl -so "$kitty_cfg/kitty.conf" "$gitea_url/kitty.conf"
  # cp "$doc_kitty/kitty.conf" "$kitty_cfg/"
  # sed -i -f "$files_dir/kitty.sed" "$kitty_cfg/kitty.conf"
  # is_debian && sed -i 's/^shell \./#: shell ./ ; /#: shell \./a shell \/bin\/bash --login' "$kitty_cfg/kitty.conf"
  printf "kitty.conf created and configured.\n"
}

kitty_bindings() {
  local bindings="bindings.list"
  local gitea_url="http://192.168.0.16:3000/Nullifidian/configs/raw/branch/main/kitty"
  curl -so "$kitty_cfg/$bindings" "$gitea_url/$bindings"
  printf "Kitty keybindings list copied to ~/.config/kitty\n"
  printf "Run the kkb script to display keybindings.\n"
}

## Execution ##

noOpt=1
optstr=":bchipr"
while getopts "$optstr" opt; do
  case "$opt" in
    b )
      exists kitty || leave "Kitty is not installed."
      printf "Copying Kitty keybindings...\n"
      kitty_bindings
    ;;
    c )
      exists kitty || leave "Kitty is not installed."
      printf "Configuring Kitty %s...\n" "$(kitty_version)"
      kitty_config
    ;;
    h )
      help 0
    ;;
    i )
      exists kitty && leave "Kitty terminal emulator $(kitty_version) already installed."
      user_in_sudo
      install_kitty
    ;;
    p )
      exists kitty || leave "Kitty is not installed."
      user_in_sudo
      purge_kitty
    ;;
    r )
      exists kitty || leave "Kitty is not installed."
      user_in_sudo
      remove_kitty
    ;;
    ? )
      printf "%s Invalid option -%s\n" "$red_error" "$OPTARG" >&2
      help 2
  esac
	noOpt=0
done
[[ "$noOpt" = 1 ]] && { printf "%s No argument passed.\n" "$red_error" >&2; help 1; }
printf "%s v%s (%s)\n" "$_script" "$_version" "$_updated"

exit