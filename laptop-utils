#!/usr/bin/env bash
##########################################################################
# Script Name  : laptop-utils
# Description  : Installs laptop-specific utilities
# Dependencies : None
# Args         : See help()
# Author       : Copyright (C) 2023, Richard Romig, LudditeGeek
# Email        : rick.romig@gmail.com | rick.romig@mymetronet.net
# Created      : 23 Mar 2023
# Updated      : 28 Dec 2025
# Comments     : Based on a script by Joe Collins.
# TODO (rick)  :
# License      : GNU General Public License, version 2.0
# License URL  : https://github.com/RickRomig/scripts/blob/main/LICENSE
##########################################################################
# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; either version 2 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
# GNU General Public License for more details.
##########################################################################

## Shellcheck Directives ##
# shellcheck source=/home/rick/bin/functionlib

## Load function library ##

if [[ -x "$HOME/bin/functionlib" ]]; then
  source "$HOME/bin/functionlib"
else
  printf "\e[91mERROR:\e[0m functionlib not found!\n" >&2; exit 1
fi

## Global Variables ##

readonly script="${0##*/}"
readonly version="8.0.25262"

## Funtions ##

help() {
	local errcode="${1:-2}"
	local updated="28 Dec 2025"
	cat << _HELP_
${orange}$script${normal} $version ($updated)
Installs laptop-specific utlities.

${green}Usage:${normal} $script [-hist]
${orange}Available options:${normal}
  -h  Show this help message and exit.
  -i  Install laptop utilities.
  -s  Display installed utilities.
  -t  Start TLP service.
_HELP_
  intro
  exit "$errcode"
}

intro() {
  cat << _INTRO_
Installs laptop-specific utilities:
 * Thermald - monitors and controls temperature.
 * ACPI - checks the state of ACPI devices.
 * TLP - advanced power management to maximize battery life.
 * TLP-RDW - TLP radio device wizard.
_INTRO_
}

install_packages() {
  local package
  local packages=(acpi thermald tlp tlp-rdw)
  for package in "${packages[@]}"; do
    if installed "$package"; then
      printf "%s installed.\n" "${package^^}"
    else
      sudo_login 2
      sudo apt-get install -y "$package"
      printf "%s installed.\n" "${package^^}"
    fi
  done
}

tlp_status() {
  local status=1
  if installed tlp; then
    is_systemd && { grep -qw active <(systemctl status tlp) && status=0; }
    is_sysv && {  grep -qw enabled <(tlp-stat -s) && status=0; }
    if [[ "$status" -eq 0 ]]; then
      printf "TLP service is active and running.\n"
      return
    fi
    printf "Starting TLP service\n"
    start_tlp_service
  else
    printf "TLP is not installed.\n"
  fi
}

start_tlp_service() {
  sudo_login 2
  if is_systemd; then
    sudo systemctl enable tlp.service > /dev/null 2>&1
    sudo systemctl start tlp.service > /dev/null 2>&1
    sudo systemctl mask systemd-rfkill.service > /dev/null 2>&1
    sudo systemctl mask systemd-rfkill.socket > /dev/null 2>&1
    printf "The tlp service is enabled and started.\n"
  elif is_sysv; then
    sudo tlp start > /dev/null 2>&1
    printf "The tlp service is started.\n"
  else
    printf "Init system is not Systemd or SysV.\n"
    printf "Manually start the TLP service.\n"
  fi
}

main() {
  local lhost noOpt opt optstr OPTARG OPTIND
  lhost="${HOSTNAME:=-$(hostname)}"
  noOpt=1
  optstr=":hist"
  while getopts "$optstr" opt; do
    case "$opt" in
      h )
        help 0
        ;;
      i )
        if is_laptop; then
          intro
          install_packages
        else
          printf "%s is not a laptop. Nothing to do.\n" "$lhost" >&2
        fi
        ;;
      s )
        if is_laptop; then
          install_packages
        else
          printf "%s is not a laptop. Nothing to do.\n" "$lhost" >&2
        fi
        ;;
      t )
        if is_laptop; then
          tlp_status
        else
          printf "%s is not a laptop. Nothing to do.\n" "$lhost" >&2
        fi
        ;;
      ? )
        printf "%s Invalid option -%s\n" "$RED_ERROR" "$OPTARG" >&2
        help 2
    esac
	  noOpt=0
  done
  [[ "$noOpt" = 1 ]] && { printf "%s No argument passed.\n" "$RED_ERROR" >&2; help 1; }
  shift "$(( OPTIND - 1 ))"
  over_line "$script $version"
  exit
}

## Execution ##

main "$@"
