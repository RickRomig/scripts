#!/usr/bin/env bash
##########################################################################
# Script Name  : install-neofetch
# Description  : Installs and configures neofetch
# Dependencies : none
# Arguments    : -c -h -i -r (See the help function for details.)
# Author       : Copyright Richard B. Romig, 25 Jul 2022
# Email        : rick.romig@gmail.com
# Comments     :
# TODO (Rick)  :
# License      : GNU General Public License, version 2.0
##########################################################################

## Shellcheck Directives ##
# shellcheck source=/home/rick/bin/functionlib
# shellcheck disable=SC1091

## Source function library ##

if [[ -x "$HOME/bin/functionlib" ]]; then
  source "$HOME/bin/functionlib"
else
  printf "\e[91mERROR:\e[0m functionlib not found!\n" >&2
  exit 1
fi

## Variables ##

readonly _script=$(basename "$0")
readonly _version="0.1.1"
readonly _updated="26 Jul 2022"
readonly cfg_dir="${HOME}/.config/neofetch"
readonly thumbnail_dir="${HOME}/.cache/thumbnails/neofetch"

## Functions ##

help() {
  local errcode="${1:-2}"
	cat << EOL
${green}Usage:${normal} $_script [OPTION]
${orange}OPTIONS:${normal}
	-c	Apply Neofetch configuration
	-h	Display help
	-i	Install and configure Neofetch
	-r	Remove Neofetch and configuration
EOL
  exit "$errcode"
}

install_neofetch() {
	if exists neofetch; then
		leave "Neofetch is already installed."
	else
		user_in_sudo
		[[ -d "$thumbnail_dir" ]] || mkdir -p "$thumbnail_dir"
		sudo apt-get updates
		sudo apt-get install neofetch -yy
		apply_config
		leave "Neofetch is installed."
	fi
}

apply_config() {
	local sed_file="${HOME}/bin/files/neofetch.sed"
	if [[ -f "$cfg_dir/config.conf" ]]; then
		sed -i -f "$sed_file" "$cfg_dir/config.conf"
		printf "Neofetch configuration applied.\n"
	elif [[ -f "$cfg_dir/config" ]]; then
		sed -i -f "$sed_file" "$cfg_dir/config"
		printf "Neofetch configuration applied.\n"
	else
		printf "Neofetch configuration not present.\n"
	fi
}

remove_neofetch() {
	user_in_sudo
	if exist neofetch; then
		sudo apt-get purge -yy > /dev/null 2>&1
		[[ -d "$thumbnail_dir" ]] && rm -rf "$thumbnail_dir"
		leave "Neofetch and configuration files removed."
	else
		leave "Neofetch is not installed. No action taken."
	fi
}

## Execution ##

clear
printf "\U1F427 %s v%s (%s)\n" "$_script" "$_version" "$_updated"
printf "Install/Remove Neofetch or apply configuration\n\n"

if [[ "$#" -eq 0 ]]; then
	echo "${lightred}ERROR:${normal} No argument passed." >&2
	help 1
else
	optstr=":chir"
	while getopts "$optstr" opt; do
		case "$opt" in
			c )
				apply_config
				exit 0
				;;
			h )
				help 0
				;;
			i )
				install_neofetch
				;;
			r )
				remove_neofetch
				;;
			? )
				echo "${lightred}ERROR:${normal}Invalid option -${OPTARG}" >&2
				help 2
				;;
		esac
	done
fi

exit
