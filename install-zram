#!/usr/bin/env bash
##########################################################################
# Script Name  : install-zram
# Description  : installs and configures Zram-tools.
# Dependencies : none
# Arguments    : none
# Author       : Copyright Â© 2025 Richard B. Romig, Mosfanet
# Email        : rick.romig@gmail.com | rick.romig@mymetronet.net
# Created      : 18 Jan 2025
# Updaged      : 26 Jan 2025
# Comments     :
# TODO (Rick)  :
# License      : GNU General Public License, version 2.0
##########################################################################

## Shellcheck Directives ##
# shellcheck source=/home/rick/bin/functionlib

## Source function library ##

if [[ -x "$HOME/bin/functionlib" ]]; then
  source "$HOME/bin/functionlib"
else
  printf "\e[91mERROR:\e[0m functionlib not found!\n" >&2
  exit 1
fi

set -eu

## Functions ##

install_zram() {
  local sed_file="$HOME/bin/files/zramswap.sed"
	sudo apt install -y zram-tools
	# sudo sed -i.bak '/ALGO/s/^#//;/PERCENT/s/^#//;s/50$/25/' /etc/default/zramswap
  sudo sed -i.bak -f "$sed_file" /etc/default/zramswap
  sudo systemctl restart zramswap.service
	printf "Zram-tools installed.\n"
}

get_swap_type() {
  local s_type
  s_type=$(/usr/bin/lsblk | grep -w SWAP | awk '{print $6}')
  echo "$s_type"
}

main() {
  local script version swap_type
  script=$(basename "$0")
  version="2.0.25026"
  swap_type=$(get_swap_type)
  case "$swap_type" in
    disk )
      printf "Swap file already exists.\n" ;;
    part )
      printf "Swap partition already exists.\n" ;;
    * )
      printf  "No swap currently exists. Installing Zram-tools ...\n"
      sudo_login 2
      install_zram
  esac
  /usr/bin/lsblk
  over_line "$script $version"
  exit
}

## Execution ##

main "$@"
