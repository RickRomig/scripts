#!/usr/bin/env bash
###############################################################################
# Script Name  : install-fonts
# Description  : Installs various Microsoft fonts
# Dependencies : cabextract, curl, wget
# Arguments    : None
# Author       : Richard B. Romig,
# Email        : rick.romig@gmail.com
# Created      : 13 Aug 2019
# Updated      : 18 Aug2024
# Comments     :
# TODO (rick)  :
# License      : GNU General Public License, version 2.0
###############################################################################

## Shellcheck Directives ##
# shellcheck source=/home/rick/bin/functionlib
# shellcheck disable=SC1091,SC2034

## Load function library ##

if [[ -x "$HOME/bin/functionlib" ]]; then
  source "$HOME/bin/functionlib"
else
  echo -e "\e[91mERROR:\e[0m functionlib not found!" >&2
  exit 1
fi

## Variables ##

_script=$(basename "$0"); readonly _script
readonly _version="4.0.24231"
font_flag=0  # 0 = no fonts installed. 1 = at least one font installed.

## Functions ##

cascadia_code() {
  local font_url font_zip ccf_dir user_ccf
  font_url="https://github.com/microsoft/cascadia-code/releases/download/v2111.01"
  font_zip="CascadiaCode-2111.01.zip"
  ccf_dir="/usr/share/fonts/truetype/cascadia-code"
  user_ccf="$HOME/.local/share/fonts"
  # Remove older versions of Caascadia Code fonts.
  if dpkg -l | grep -qw fonts-cascadia-code; then
    sudo apt-get remove fonts-cascadia-code -yy   # if installed from distro repo
  elif [[ -d "$ccf_dir" ]]; then
    if find "$ccf_dir" -type f; then
      # installed from GitHub
      sudo rm -rf "$ccf_dir"/otf/
      sudo rm -rf "$ccf_dir"/ttf/
      sudo rm -rf "$ccf_dir"/woff2/
    fi
  else
    [[ -d "$ccf_dir" ]] || sudo mkdir -p "$ccf_dir"
  fi
  echo "Installing Cascadia Code fonts..."
  check_package wget
  wget -q -P "$tmp_dir/" "$font_url/$font_zip"
  [[ -d "$ccf_dir" ]] || sudo mkdir -p "$ccf_dir"
  sudo unzip "$tmp_dir/$font_zip" -d "$ccf_dir"
  sudo cp "$ccf_dir"/ttf/*.ttf "$user_ccf"/
  echo "Cascadia Code fonts installed."
}

nerd_fonts() {
  local font fonts font_dir font_dir
  font_dir="/usr/share/fonts"
  font_url="https://github.com/ryanoasis/nerd-fonts/releases/download/v3.0.2"
  [[ -d "$font_dir" ]] || sudo mkdir -p "$font_dir"
  fonts=( "FiraCode" "Go-Mono" "Hack" "Inconsolata" "Iosevka" "JetBrainsMono" "Mononoki" "RobotoMono" "SourceCodePro" )
  check_package wget
  printf "Installing Nerd fonts...\n"
  for font in "${fonts[@]}"; do
	  wget -P "$nerd_dir" "$font_url/$font.zip"
	  sudo unzip "$nerd_dir/$font.zip" -d "$font_dir/$font/"
  done
  printf "Nerd fonts installed.\n"
}

carlito_caladea() {
  # Installs into /usr/share/fonts/truetype/crosextra
  if [[ -d /usr/share/fonts/truetype/crosextra ]]; then
    printf "Carlito and Caladea fonts are already installed.\n"
  else
    printf "Installing Carlito and Caladea fonts...\n"
    sudo apt upgrade -yyq
    sudo apt install fonts-crosextra-carlito fonts-crosextra-caladea -yyq
    printf "Carlito and Caladea fonts installed.\n"
  fi
}

ms_core_fonts() {
  # MS TTF core fonts: Andale Mono, Arial Black, Arial (Bold, Italic, Bold Italic),
  # Comic Sans MS (Bold), Courier New (Bold, Italic, Bold Italic), Georgia (Bold,
  # Italic, Bold Italic), Impact, Times New Roman (Bold, Italic, Bold Italic),
  # Trebuchet (Bold, Italic, Bold Italic), Verdana (Bold, Italic, Bold Italic),
  # Webdings
  # Installs into /usr/share/fonts/truetype/msttcorefonts
  # dpkg -l | grep -w ttf-mscorefonts-installer

  if [[ -d /usr/share/fonts/truetype/msttcorefonts ]]; then
    printf "MS core fonts are aleady installed.\n"
  else
    printf "Installing MS core true-type fonts...\n"
    sudo apt upgrade -yyq
    sudo apt install ttf-mscorefonts-installer -yyq
    printf "MS core fonts installed.\n"
  fi
}

vista_fonts() {
  # Windows vista fonts: Calibri, Cambria, Candara, Consolas, Constantia, Corbel
  local archive dl_host dl_path fonts_dir start_dir url
  dl_host="sourceforge.net"
  dl_path="projects/mscorefonts2/files/cabs"
  archive="PowerPointViewer.exe"
  url="https://$dl_host/$dl_path/$archive"
  fonts_dir="/usr/share/fonts/truetype/vista"
  start_dir="$PWD"

  if [[ -d /usr/share/fonts/truetype/vista ]]; then
    printf "Vista fonts are already installed.\n"
  else
    check_package curl
    # Create font directory if required
    [[ -d "$fonts_dir" ]] || sudo mkdir -p "$fonts_dir"

    # Check to see if cabextract is installed
    check_package cabextract

    printf "Installing Vista true-type fonts...\n"
    # Download the fonts to the font download directory
    if [[ "$start_dir" != "$font_dl_dir" ]]; then
      pushd "$font_dl_dir" || die "pushd failed"
    fi
    if [[ ! -e "$archive" ]]; then
      curl -A '' -LO "$url"
      printf "%s downloaded to %s\n" "$archive" "$font_dl_dir"
    fi

    # Extract the fonts from the archive
    /usr/bin/cabextract -L -F ppviewer.cab -d "$temp_dir" "$archive"
    sudo /usr/bin/cabextract -L -F '*.TT[FC]' -d "$fonts_dir" "$temp_dir/ppviewer.cab"
    if [[ "$start_dir" != "$font_dl_dir" ]]; then
      popd || die "popd failed"
    fi

    # Rename and apply permissions to fonts
    if [[ "$start_dir" != "$fonts_dir" ]]; then
      pushd "$fonts_dir" || die "pushd failed"
    fi
    mv cambria.ttc cambria.ttf
    chmod 600 calibri{,b,i,z}.ttf cambria{,b,i,z}.ttf candara{,b,i,z}.ttf consola{,b,i,z}.ttf constan{,b,i,z}.ttf corbel{,b,i,z}.ttf
    if [[ "$start_dir" != "$fonts_dir" ]]; then
      popd || die "popd failed"
    fi
    printf "Vista fonts installed.\n"
  fi
}

# shellcheck disable=SC2317 # Don't warn about unreachable commands in this function
# ShellCheck may incorrectly believe that code is unreachable if it's invoked by variable name or in a trap.
cleanup() {
  [[ -f "$tmp_file" ]] && rm "$tmp_file"
  [[ -d "$tmp_dir" ]] && rm -rf "$tmp_dir"
  [[ -d "$temp_dir" ]] && rm -rf "$temp_dir"
  [[ -d "$font_dl_dir" ]] && rm -rf "$font_dl_dir"
  [[ -d "$nerd_dir" ]] && rm -rf "$nerd_dir"
}

## Execution ##

trap cleanup EXIT INT QUIT TERM

while true; do
  echo "$_script v$_version"
  echo "Install extra fonts"
  COLUMNS=40
  options=("Cascadia Code" "Nerd Fonts" "MS TTF Core Fonts" "Carlito and Caladea Fonts" "Vista Fonts" "Quit and Exit")
  PS3="Choose a font to install: "
  select _opt in "${options[@]}"
  do
    case $REPLY in
      1 )
        user_in_sudo
        tmp_file=$(mktemp) || die "Failed to create temporary file." 1
        tmp_dir=$(mktemp -d) || die "Failed to create temporary directory." 1
        cascadia_code
        font_flag=1
        break
        ;;
      2 )
        user_in_sudo
        nerd_dir=$(mktemp -d) || die "Failed to create temporary directory." 1
        nerd_fonts
        font_flag=1
        break
      ;;
      3 )
        user_in_sudo
        ms_core_fonts
        font_flag=1
        break
        ;;
      4 )
        user_in_sudo
        carlito_caladea
         break
       font_flag=1
        ;;
      5 )
        user_in_sudo
        temp_dir=$(mktemp -d) || die "Failed to create temporary diectory." 1
        font_dl_dir=$(mktemp -d) || die "Failed to create temporary diectory." 1
        vista_fonts
        font_flag=1
        break
        ;;
      6 )
        (( font_flag != 0 )) && sudo /usr/bin/fc-cache -f > /dev/null 2>&1
        leave ""
        ;;
      * )
        echo "${lightred}Invalid Choice!${normal}" >&2
    esac
  done
done
