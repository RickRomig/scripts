#!/usr/bin/env bash
###############################################################################
# Script Name  : install-timeshift
# Description  : installs and configures timeshift
# Dependencies : ~/bin/files/timeshift.sed
# Arguments    : none
# Author       : Copyright Â© 2024, Richard B. Romig, Mosfanet
# Email        : rick.romig@gmail.com | rick.romig@mymetronet.com
# Created      : 03 Jun 2024
# Last updated : 12 Dec 2024
# Comments     : My default configuration is 5 daily, 3 weekly, & 2 monthly snapshots.
# TODO (Rick)  :
# License      : GNU General Public License, version 2.0
###############################################################################

## Shellcheck Directives ##
# shellcheck source=/home/rick/bin/functionlib

## Load function library ##

if [[ -x "$HOME/bin/functionlib" ]]; then
  source "$HOME/bin/functionlib"
else
  echo -e "\e[91mERROR:\e[0m functionlib not found!" >&2
  exit 1
fi

set -eu

## Functions ##

configure_timeshift() {
  local ts_dir ts_json ts_sed
  ts_dir="/etc/timeshift"
  ts_json="timeshift.json"
  ts_sed="$HOME/bin/files/timeshift.sed"
  if [[ -f "$ts_sed" ]]; then
    printf "Configuring Timeshift...\n"
    sudo cp -v "$ts_dir/default.json" "$ts_dir/$ts_json"  # copy default json file
    sudo sed -i -f "$ts_sed" "$ts_dir/$ts_json" # apply settings
    sudo sed -i 's/^"\//    "\//;s/^"/  "/' "$ts_dir/$ts_json"  # to get leading spaces right in json file
  else
    printf "The %s configuration script was not found. Configure using the GUI application.\n" "$ts_sed"
  fi
}

install_timeshift() {
  printf "Installing Timeshift...\n"
  sudo apt-get install -y timeshift
  configure_timeshift
  printf "%s installed and configured.\n" "$(timeshift --version)"
}

main() {
  local script version
  script=$(basename "$0")
  version="2.4.24347"
  if exists timeeshift; then
    printf "%s is already installed.\n" "$(timeshift --version)"
  elif ! in_repos timeshift; then
    printf "Timeshift is not availabe in %s  repositories.\n" "$(get_distribution)"
  else
    sudo_login 2
    install_timeshift
  fi
  over_line "$script v$version"
  exit
}

## Execution ##

main "$@"
