#!/usr/bin/env bash
###############################################################################
# Script Name  : install-timeshift
# Description  : installs and configures timeshift
# Dependencies : ~/bin/files/timeshift.sed
# Arguments    : none
# Author       : Copyright Â© 2024, Richard B. Romig, Mosfanet
# Email        : rick.romig@gmail.com | rick.romig@mymetronet.com
# Created      : 03 Jun 2024
# Last updated : 13 Aug 2024
# Comments     : My default configuration is 5 daily, 3 weekly, & 2 monthly snapshots.
# TODO (Rick)  :
# License      : GNU General Public License, version 2.0
###############################################################################

## Shellcheck Directives ##
# shellcheck source=/home/rick/bin/functionlib

## Load function library ##

if [[ -x "$HOME/bin/functionlib" ]]; then
  source "$HOME/bin/functionlib"
else
  echo -e "\e[91mERROR:\e[0m functionlib not found!" >&2
  exit 1
fi

set -eu

## Global variables ##
_script=$(basename "$0"); readonly _script
readonly _version="2.1.24226"

## Functions ##

configure_timeshift() {
  local ts_dir ts_json sed_dir ts_sed
  ts_dir="/etc/timeshift"
  ts_json="timeshift.json"
  sed_dir="$HOME/bin/files"
  ts_sed="timeshift.sed"
  if [[ ! -f "$sed_dir/$ts_sed" ]]; then
    echo "Configuring Timeshift..."
    sudo cp -v "$ts_dir/default.json" "$ts_dir/$ts_json"
    sudo sed -i -f "$sed_dir/$ts_sed" "$ts_dir/$ts_json"
    sudo sed -i 's/^"\//    "\//;s/^"/  "/' "$ts_dir/$ts_json"
  else
    echo "The $ts_sed configuration script was not found. Configure using the GUI application."
  fi
}

install_timeshift() {
  echo "Installing Timeshift..."
  sudo_login 2
  sudo apt-get install -y timeshift
  configure_timeshift
  echo "$(timeshift --version) installed and configured."
}

## Execution ##

in_repo timeshift || leave "Timeshift is not availabe in $(get_distribution) repositories."
if exists timeeshift; then
  echo "Timeshift is already installed."
else
  install_timeshift
fi
leave "$_script v$_version"
