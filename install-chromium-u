#!/usr/bin/env bash
##########################################################################
# Script Name  : install-chromium-u
# Description  : Installs the ungoogled-chromium browser
# Dependencies : None
# Arguments    : See help function
# Author       : Copyright (C) 2020, Richard B. Romig, 05 Jul 2020
# Email        : rick.romig@gmail.com | rick.romig@mymetronet.net
# Comments     : Debian 11 bullseye, LMDE 5 else, BunsenLabs 11 berylium
# TODO (Rick)  : Test
# License      : GNU General Public License, version 2.0
##########################################################################

## Shellcheck Directives ##
# shellcheck source=/home/rick/bin/functionlib
# shellcheck disable=SC1091

## Load function library ##

if [[ -x "$HOME/bin/functionlib" ]]; then
  source "$HOME/bin/functionlib"
else
  printf "\e[91mERROR:\e[0m functionlib not found!\n" >&2
  exit 1
fi

## Variables ##

_script=$(basename "$0"); readonly _script
readonly _script
readonly _version="0.4.3 - beta"
readonly _updated="18 Mar 2024"
readonly source_list="/etc/apt/sources.list.d/home-ungoogled_chromium.list"
readonly trusted_gpg="/etc/apt/trusted.gpg.d/home_ungoogled_chromium.gpg"

## Functions ##

uc_version() {
  ungoogled_chromium -- version # need to get proper command
}

install_ungoogled_chrome() {
  local repo_url="deb http://download.opensuse.org/repositories/home:/ungoogled_chromium/Debian_Bullseye/ /"
  local key_url="https://download.opensuse.org/repositories/home:/ungoogled_chromium/Debian_Bullseye/Release.key"

  sudo_login 2
  show_me "Creating source list"
  echo "$repo_url" | sudo tee "$source_list" > /dev/null
  show_me "Adding trusted key"
  curl -fsSL "$key_url" | gpg --dearmor | sudo tee "$trusted_gpg" > /dev/null
  show_me "Installing ungoogled-chromium"
  sudo apt-get update
  sudo apt-get install ungoogled-chromium
  printf "ungoogled-chromium %s installed.\b" "$(uc_version)"
}

remove_ungoogle_chrome() {
  sudo_login 2
  show_me "Purging  ungoogled-chrome"
  sudo apt-get purge ungoogled-chrome
  [[ -f "$source_list" ]] && sudo rm "$source_list"
  [[ -f "$trusted_gpg" ]] && sudo rm "$trusted_gpg"
  printf "ungoogled-chrome removed.\n"
}

distro_check() {
  ver_code=$(lsb_release --codename --short)
  case $ver_code in
    bullseye|elsie )
      return "$TRUE"
    ;;
    * )
      return "$FALSE"
  esac
}

help() {
	errcode="${1:-2}"
	cat << END_HELP
${green}Usage:${normal} $_script [OPTION]
${orange}OPTIONS:${normal}
	-h	Display help
	-i	Install application
	-r	Remove application
  -v  Enable verbose mode
  To be installed on Debian 11 Bullseye only
  $_script $_version (Updated $_updated)
END_HELP
  exit "$errcode"
}

show_me() {
  local message="$1"
  [[ "$verbose_mode" = 0 ]] && cecho "$message"
}

## Execution ##

printf "Installs the ungoogled chromium browser on Debian-based systems./n"

verbose_mode=1
noOpt=1
optstr=":hirv"
while getopts "$optstr" opt; do
	case "$opt" in
		h )
			help 0
		;;
		i )
			exists ungoogled-chrome && leave "ungoogled-chrome $(uc_version) is already installed."
      distro_check || leave "$ver_code: Distribution is not supported."
			install_ungoogled_chrome
		;;
		r )
			exists ungoogled-chrome || leave "ungoogled-chrome is not installed."
			remove_ungoogled_chrome
		;;
    v )
      verbose_mode=0
      show_me "Verbose mode enabled."
    ;;
		? )
			printf "%s Invalid option -%s\n" "$red_error" "$OPTARG" >&2
			help 2
	esac
	noOpt=0
done
[[ "$noOpt" = 1 ]] && { printf "%s No argument passed.\n" "$red_error" >&2; help 1; }
shift "$(( OPTIND - 1 ))"
leave "$_script $_version (Updated $_updated)"